function getSampleSize(e,t,n){let i=e,a=t,s=n,r=s-s*i,o=Math.abs(s*i),u=s*(1-s)+r*(1-r),l=2*a*u*Math.log(1+Math.sqrt(u)/o)/(o*o);return Math.round(l)}function xlfNormSDist(e){if(e<0)return 1-xlfNormSDist(-e);var t=1/(1+.2316419*e);return 1-Math.exp(-e*e/2)/Math.sqrt(2*Math.PI)*t*(.31938153+t*(t*(1.781477937+t*(1.330274429*t-1.821255978))-.356563782))}function xlfNormalPDF1a(e,t,n){return Math.exp(-Math.pow(e-t,2)/(2*Math.pow(n,2)))/(n*Math.sqrt(2*Math.PI))}function xlfNormalPDF1b(e,t,n){return Math.exp(-.5*Math.pow((e-t)/n,2))/(n*Math.sqrt(2*Math.PI))}function xlfNormalSdistPDF(e){return Math.exp(-.5*e*e)/Math.sqrt(2*Math.PI)}var iframe=document.querySelector('[name="galaxy"]').contentWindow.document,pagination=iframe.querySelector(".C_PAGINATION_ROWS_LONG > label").innerText.split(" of ");pagination[0].split("1-")[1]<pagination[1]&&alert("make sure the page is displaying all the rows - currently dipslaying only "+pagination[0].split("1-")[1]+" there is however a total of "+pagination[1]);let Label=first=second=third=fourth=fifth=segment=sessions="empty";function Dimensions(e,t,n,i,a,s,r,o,u){this.Label=e,this.First=t,this.Second=n,this.Third=i,this.Fourth=a,this.Fifth=s,this.Segment=r,this.Sessions=o,this.Conversions=u,this.Concat=""}function Results(e,t,n,i,a){this.Label=e,this.Segment=n,this.Sessions=i,this.Conversions=a,this.Concat=t}function Results_final(e,t,n,i,a,s,a,r,o,u,l,c,d,m){this.Label=e,this.Split=t,this.Segment=n,this.Control_users=i,this.Variant_users=s,this.control_conversion=a,this.variant_conversion=r,this.Control_cvr_pct=(100*o).toFixed(2),this.Variant_cvr_pct=(100*u).toFixed(2),this.Uplift_pct=(100*uplift).toFixed(2),this.ConfLevel_pct=(100*l).toFixed(2),this.SampleSizeRequired=c,this.DaysToEnoughData=Math.round(c/(s/d)),this.EnoughData=c<s?"Enough data collected":"need more data",(100*l).toFixed(2)>.95&&c<s?this.StatSig="Positive & SS":(100*l).toFixed(2)<.05&c<s?this.StatSig="Negative & SS":this.StatSig="Cant conclude yet",this.Generated_during_test=Math.round(m*u-m*o),this.Potential_monthly_extra=Math.round((m*u-m*o)/d*365/12)}var _table_=document.createElement("table"),_tr_=document.createElement("tr"),_th_=document.createElement("th"),_td_=document.createElement("td");function buildHtmlTable(e){for(var t=_table_.cloneNode(!1),n=addAllColumnHeaders(e,t),i=0,a=e.length;i<a;++i){for(var s=_tr_.cloneNode(!1),r=0,o=n.length;r<o;++r){var u=_td_.cloneNode(!1);cellValue=e[i][n[r]],u.appendChild(document.createTextNode(e[i][n[r]]||"")),s.appendChild(u)}t.appendChild(s)}return t}function addAllColumnHeaders(e,t){for(var n=[],i=_tr_.cloneNode(!1),a=0,s=e.length;a<s;a++)for(var r in e[a])if(e[a].hasOwnProperty(r)&&-1===n.indexOf(r)){n.push(r);var o=_th_.cloneNode(!1);o.appendChild(document.createTextNode(r)),i.appendChild(o)}return t.appendChild(i),n}var dimensions=[],dimensions_array=[];for(dimensions=iframe.querySelectorAll('[class^="ID-dimension-data-"]'),i=0;i<dimensions.length;i++)dimensions_array.push(dimensions[i].className),console.log(dimensions_array);(dimensions=new Set(dimensions_array)).size,dimensions_name=iframe.querySelectorAll('[data-guidedhelpid*="data-table-dimension-analytics"]');let dimensions_name_list=[];for(t=1;t<dimensions_name.length;t++)dimensions_name_list.push(dimensions_name[t].innerText);metrics_name=iframe.querySelectorAll('[data-guidedhelpid*="data-table-column-analytics"]');let metrics_name_list=[];for(t=0;t<metrics_name.length;t++)metrics_name_list.push(metrics_name[t].innerText);let total_array=[],metrics_array_columns=[],count_group_list=[],count_group=[],dimensions_array_columns=[],read_metrics=[],read_dimensions=[],Sessions_selection=[0],Conversions_selection=[0],collectData=function(){var e=[];for(count_group_list=iframe.querySelectorAll('[class^="ID-row-"]'),i=0;i<count_group_list.length;i++)e.push(iframe.querySelectorAll('[class^="ID-row-"]')[i].getAttribute("class"));total_array=[];for(i=0;i<e.filter(e=>!e.includes("ACTION-mouse")).length;i++)for(console.log(i),j=0;j<e.filter(e=>e.includes("ACTION-mouse")).length/e.filter(e=>!e.includes("ACTION-mouse")).length;j++){for(read_dimensions=[],dimensions_array_columns=[],read_metrics=[],k=0;k<dimensions.size;k++)read_dimensions="#ID-rowTable > tbody > tr.ID-row-"+i+"> td.ID-dimension-data-"+k,dimensions_array_columns.push(iframe.querySelector(read_dimensions).innerText);for(read_metrics=[],metrics_array_columns=[],l=0;l<iframe.querySelectorAll('[class*="ID-metric-column-"').length;l++)metrics_array_columns.push(iframe.querySelectorAll('[class*="ID-metric-column-"')[l].innerText);segment="#ID-rowTable > tbody > tr.ID-row-"+i+"-0-"+j+".ACTION-mouse.TARGET-row-"+i+"-0-"+j+"> td:nth-child(2) > span",rowMetric="#ID-rowTable > tbody > tr.ID-row-"+i+"-0-"+j+".ACTION-mouse.TARGET-row-"+i+"-0-"+j,sessions_conversions_col=iframe.querySelector(rowMetric),Label=dimensions_array_columns[0],null==dimensions_array_columns[1]||(first=dimensions_array_columns[1]),null==dimensions_array_columns[2]||(second=dimensions_array_columns[2]),null==dimensions_array_columns[3]||(third=dimensions_array_columns[3]),null==dimensions_array_columns[4]||(fourth=dimensions_array_columns[4]),null==dimensions_array_columns[5]||(fifth=dimensions_array_columns[5]),segment=iframe.querySelectorAll(segment)[0].innerText,sessions=conversions=sessions_conversions_col.querySelectorAll('[class*="COLUMN-analytics"]')[parseInt(Sessions_selection)].innerText.split(" (")[0].replace(",",""),conversions=sessions_conversions_col.querySelectorAll('[class*="COLUMN-analytics"]')[parseInt(Conversions_selection)].innerText.split(" (")[0].replace(",",""),total_array.push(new Dimensions(Label,first,second,third,fourth,fifth,segment,sessions,conversions))}};collectData();const getValue=(e,t)=>{let n=e;return t.split(".").forEach(e=>{n=n[e]}),n};let grouping_dimensions="",unique_concat=[],unique_segment=[],unique_variant=[],Results_array=[],group_dim=function(t){for(unique_concat=[],unique_segment=[],unique_variant=[],q=0;q<total_array.length;q++){var n=[],i=[];for(unique_segment.push(getValue(total_array,q+".Segment")),unique_variant.push(getValue(total_array,q+".Label")),i=""==t?"Label":t,w=0;w<i.length;w++)n.push(getValue(total_array,q+"."+i[w])),console.log(n,w),total_array[q].Concat=""==t?"":n.join("_"),console.log(n.join("_"));""==t?unique_concat.push(""):unique_concat.push(n.join("_"))}unique_concat=[...new Set(unique_concat)].sort(),unique_segment=[...new Set(unique_segment)].sort(),unique_variant=[...new Set(unique_variant)].sort(),Results_array=[];for(e=0;e<unique_concat.length;e++)for(d=0;d<unique_segment.length;d++)for(f=0;f<unique_variant.length;f++)results_sessions=total_array.filter(function(t){return t.Concat==unique_concat[e]&&t.Label==unique_variant[f]&&t.Segment==unique_segment[d]}).reduce(function(e,t){return e+parseInt(t.Sessions)},0),results_conversions=total_array.filter(function(t){return t.Concat==unique_concat[e]&&t.Label==unique_variant[f]&&t.Segment==unique_segment[d]}).reduce(function(e,t){return e+parseInt(t.Conversions)},0),Results_array.push(new Results(unique_variant[f],unique_concat[e],unique_segment[d],results_sessions,results_conversions))};group_dim(grouping_dimensions);let StartDate=iframe.querySelector(".ID-start").textContent,Date_start=new Date(StartDate),EndDate=iframe.querySelector(".ID-end").textContent,Date_end=new Date(EndDate),Days_run=(Date.parse(Date_end)-Date.parse(Date_start))/1e3/60/60/24,users_segment=unique_segment[0],segment_analyse=unique_segment.filter(e=>!users_segment.includes(e)),control_label=unique_variant[0],Results_array_math=[],results_display=function(e,t,n){if(n!=i)i=n;else var i=unique_segment.filter(e=>!t.includes(e));for(Results_array_math=[],g=0;g<unique_concat.length;g++)for(f=0;f<unique_variant.length;f++){var a=[],s=[],r=[],o=[],u=[],l=[],c=[],m=[],_=[];for(d=0;d<i.length;d++)a=Results_array.filter(function(n){return n.Concat==unique_concat[g]&&n.Label==e&&n.Segment==t}).reduce(function(e,t){return e+parseInt(t.Sessions)},0),r=Results_array.filter(function(e){return e.Concat==unique_concat[g]&&e.Label==unique_variant[f]&&e.Segment==t}).reduce(function(e,t){return e+parseInt(t.Sessions)},0),s=Results_array.filter(function(t){return t.Concat==unique_concat[g]&&t.Label==e&&t.Segment==i[d]}).reduce(function(e,t){return e+parseInt(t.Conversions)},0),o=Results_array.filter(function(e){return e.Concat==unique_concat[g]&&e.Label==unique_variant[f]&&e.Segment==i[d]}).reduce(function(e,t){return e+parseInt(t.Conversions)},0),Total_users=Results_array.filter(function(e){return e.Concat==unique_concat[g]&&e.Segment==t}).reduce(function(e,t){return e+parseInt(t.Sessions)},0),u=s/a,l=o/r,uplift=(l-u)/u,c=Math.pow(u*(1-u)/a,.5),m=Math.pow(l*(1-l)/r,.5),_=xlfNormSDist((l-u)/Math.pow(Math.pow(c,2)+Math.pow(m,2),.5)),SampleSize=getSampleSize(uplift,.95,u),Results_array_math.push(new Results_final(unique_variant[f],unique_concat[g],i[d],a,s,r,s,o,u,l,_,SampleSize,Days_run,Total_users))}};const newNode=iframe.createElement("div");newNode.setAttribute("id","AB_Div");const RadioNode=iframe.createElement("div");RadioNode.setAttribute("id","Radio_Label");const RadioNodeSessions=iframe.createElement("div");RadioNodeSessions.setAttribute("id","Radio_Node_Sessions");const RadioNodeMetrics=iframe.createElement("div");RadioNodeMetrics.setAttribute("id","Radio_Node_Metrics");const CheckboxNode=iframe.createElement("div");CheckboxNode.setAttribute("id","Checkbox_Label");const SegmentRadioNode=iframe.createElement("div");SegmentRadioNode.setAttribute("id","SegmentRadio_Label");const CheckboxSegments=iframe.createElement("div");CheckboxSegments.setAttribute("id","Checkbox_Segments");const btn=iframe.createElement("button");btn.setAttribute("class","btn btn-primary"),btn.innerHTML="Delete All tables",btn.name="deleteTable",btn.onclick=function(){var e=iframe.querySelectorAll(".AB_Results_Table");[].forEach.call(e,function(e){e.remove()}),updateButton()};const btnUpdate=iframe.createElement("button");btnUpdate.setAttribute("class","btn btn-primary"),btnUpdate.innerHTML="Update",btnUpdate.name="btnUpdate";const list=iframe.getElementById("ID-tabControl");list.insertBefore(newNode,list.children[0]),newNode.appendChild(btn),newNode.appendChild(btnUpdate),newNode.appendChild(RadioNodeSessions),newNode.appendChild(RadioNodeMetrics),newNode.appendChild(RadioNode),newNode.appendChild(CheckboxNode),newNode.appendChild(SegmentRadioNode),newNode.appendChild(CheckboxSegments);for(var output="",output2="",output3="",output4="",output5="",output6="",unique_dimensions=["First","Second","Third","Fourth","Fifth"],i=0;i<unique_variant.length;i++)output2+=0==i?"Choose the control: "+unique_variant[i]+':<input type="radio" checked="true" value="'+unique_variant[i]+'" name="Label">':unique_variant[i]+':<input type="radio" value="'+unique_variant[i]+'" name="Label">',iframe.getElementById("Radio_Label").innerHTML=output2;for(var iiii=0;iiii<metrics_array_columns.length;iiii++)output4+=0==iiii?"Choose the Users metric: "+metrics_array_columns[iiii]+':<input type="radio" checked="true" value="'+iiii+'" name="Sessions Metric">':metrics_array_columns[iiii]+':<input type="radio" value="'+iiii+'" name="Sessions Metric">',iframe.getElementById("Radio_Node_Sessions").innerHTML=output4;for(var iiiii=0;iiiii<metrics_array_columns.length;iiiii++)output5+=0==iiiii?"Choose the Conversion metric: "+metrics_array_columns[iiiii]+':<input type="radio" checked="true" value="'+iiiii+'" name="Conversions Metric">':metrics_array_columns[iiiii]+':<input type="radio" value="'+iiiii+'" name="Conversions Metric">',iframe.getElementById("Radio_Node_Metrics").innerHTML=output5;for(var ii=0;ii<unique_segment.length;ii++)output3+=0==ii?"Choose the User base: "+unique_segment[ii]+':<input type="radio" checked="true" value="'+unique_segment[ii]+'" name="Segment">':unique_segment[ii]+':<input type="radio" value="'+unique_segment[ii]+'" name="Segment">',iframe.getElementById("SegmentRadio_Label").innerHTML=output3;output="Split by: ";for(var iii=0;iii<dimensions_name_list.length;iii++)output+='<input type="checkbox" value='+unique_dimensions[iii]+' name="checkbox_dimensions">   '+dimensions_name_list[iii]+"   ",iframe.getElementById("Checkbox_Label").innerHTML=output;for(var iiiiii=0;iiiiii<unique_segment.length;iiiiii++)output6+=0==iiiiii?"Segments to analyse: "+unique_segment[iiiiii]+':<input type="checkbox" value="'+unique_segment[iiiiii]+'" name="Checkbox_Segments">':unique_segment[iiiiii]+':<input type="checkbox" checked="true" value="'+unique_segment[iiiiii]+'" name="Checkbox_Segments">',iframe.getElementById("Checkbox_Segments").innerHTML=output6;let renderTable=function(e){var t=document.body.appendChild(buildHtmlTable(e));t.setAttribute("class","AB_Results_Table"),t.setAttribute("id","table"+unique_concat),t.setAttribute("border","1px solid"),t.setAttribute("width","100%"),t.style.color="black",newNode.appendChild(t);let n="",i=Object.keys(e[0]).join(","),a=e.map(e=>Object.values(e).join(",")).join("\n");var s=encodeURI(n+="data:text/csv;charset=utf-8,"+i+"\n"+a);const r=iframe.createElement("a");r.setAttribute("href",s),r.setAttribute("download",StartDate+"_"+EndDate+"("+Days_run+"days_run) "+unique_concat+".csv"),r.setAttribute("class","AB_Results_Table"),r.innerHTML="Download CSV",r.name="Download CSV",newNode.appendChild(r)};results_display(control_label,users_segment,segment_analyse),renderTable(Results_array_math);let grouping_dimensions_compare=[],checkboxValues=[],updateButton=function(){if(Sessions_selection=iframe.querySelector('input[name="Sessions Metric"]:checked').value,Conversions_selection=iframe.querySelector('input[name="Conversions Metric"]:checked').value,control_label_compare=iframe.querySelector('input[name="Label"]:checked').value,segment_compare=iframe.querySelector('input[name="Segment"]:checked').value,segment_analyse_box=iframe.querySelectorAll('input[name="Checkbox_Segments"]:checked'),0==segment_analyse_box.length)segment_analyse="";else for(segment_analyse=[],r=0;r<segment_analyse_box.length;r++)segment_analyse.push(String(segment_analyse_box[r].value));if(0==(checkboxValues=iframe.querySelectorAll('input[name="checkbox_dimensions"]:checked')).length)grouping_dimensions_compare="";else for(grouping_dimensions_compare=[],r=0;r<checkboxValues.length;r++)grouping_dimensions_compare.push(String(checkboxValues[r].value));collectData(),group_dim(grouping_dimensions_compare),results_display(control_label_compare,segment_compare,segment_analyse),renderTable(Results_array_math),control_label=control_label_compare};btnUpdate.onclick=function(){updateButton()};
